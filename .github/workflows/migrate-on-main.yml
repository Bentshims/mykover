name: Run migrations on Supabase

on:
  push:
    branches: [main]
    paths:
      - "backend/database/migrations/**"
      - "backend/package.json"
      - "backend/package-lock.json"
      - "backend/config/**"
      - "backend/start/env.ts"

concurrency:
  group: migrate-prod
  cancel-in-progress: false

jobs:
  migrate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Run migrations
        env:
          NODE_ENV: production
          DB_HOST: ${{ secrets.SUPABASE_DB_HOST }}
          DB_PORT: ${{ secrets.SUPABASE_DB_PORT }}
          DB_USER: ${{ secrets.SUPABASE_DB_USER }}
          DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.SUPABASE_DB_DATABASE }}
          PORT: "3333"
          HOST: "0.0.0.0"
          LOG_LEVEL: "info"
          APP_KEY: ${{ secrets.APP_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: "dummy"
          GOOGLE_CLIENT_SECRET: "dummy"
          GOOGLE_REDIRECT_URI: "http://localhost/dummy"
          SMTP_HOST: "localhost"
          SMTP_PORT: "1025"
          SMTP_USER: "dummy"
          SMTP_PASSWORD: "dummy"
          SMS_PROVIDER_API_KEY: "dummy"
          SMS_PROVIDER_API_SECRET: "dummy"
          OTP_EXPIRES_MINUTES: "5"
        run: node ace migration:run --force
